---
title: "Structural Equation Modeling"
output: github_document
  
---
This is a  series of predictive models looking at how observable factors such as microplastic type, number, and inputs correlate with unobservable factors such as environmental conditions and influence. These models utilize structural equation modeling package "semplot" and the "lavaan" package to produce path analysis
plots to examine the direction and strength of the relationship between variables.
For more information  follow these links

Lavaan package (https://lavaan.ugent.be/)
Sem package (https://cran.r-project.org/web/packages/sem/sem.pdf)

Structural equation models were chosen based upon the types of variables (see key terms below) and the combinations to indicate correlations. Structural regression, path analysis and factor analysis models were created. 
```{r}
library("png")
pp4 <- readPNG("pathlegend4.png")
plot.new() 
rasterImage(pp4,0,0,1,1)
```

## Data preparation
### Note: This data was made for instructional purposes and holds no true value. Variances and covariances are high in certain models and should be taken as unreliable
```{r ,warning=FALSE, message=FALSE}


 
#loading in required packages
library(lavaan)  #for performing the CFA
library(semPlot)  #for plotting your CFA
library(dplyr)  #for subsetting data 


#reading in data
semdata <- read.csv("GIS_R_Micro.csv")
#add column names
names(semdata) <- c("Sample","Number","ChemType","PhysType","Color","Date","Lat","Lon","Inputs","Proximity","Zones")
head(semdata)  #view data file to see what data is pulled in
```
## Path diagram for models
Structural equation models have generalized objects that represent paths, variables, and markers and are represented with the diagram below

### Key terms
 observed variable: a variable that exists in the data 
 latent variable: a variable that is constructed and does not exist in the data
 exogenous variable: A variable that is independent of other variables within the system and is treated as a single entity
 endogenous variable: A variable whos change is reliant on its relationship with other variables in a system
 Green line: positive correlation
 Red line: negative correlation
 Dashed line: non-significant correlation

```{r, warning=FALSE, message=FALSE}

pp <- readPNG("pathlegend1.png")
plot.new() 
rasterImage(pp,0,0,1,1)

```


# Model fit 1 Structural Regression Model
## Path diagram for model 1
This first model creates latent variables of Environmental Conditions (CON) and Influence of Urban Inputs (INF). This model not only regresses upon each of the observable variables to determine correlation but also measures the correlation between the latent variables. This is indicated by the numbers preceding the arrows.
```{r, warning=FALSE, message=FALSE}
#Creating the sem model with latent variables
#Creating predictor variables by regression of latent variables
sem.model.measurement <- "CON =~ 1*Number + ChemType + PhysType + Color
Infl =~ 1*Number + Inputs + Proximity + Zones
CON ~ Sample + Infl
Infl ~ Sample + CON"

#attaching model to sem and reading data
sem.fit.measurement <- sem(sem.model.measurement, data = semdata)
#summarizing model and plotting
summary(sem.fit.measurement, fit.measures = TRUE)
semPaths(sem.fit.measurement, "par", edge.label.cex = .75, edge.label.position= .5, fade = FALSE)  #plot our CFA. you can change layout with layout = argument. see ?semPaths() for more.
```


# Model fit 2 Endogenous factor analysis
## Path diagram for model 2
The second model is a single factor analysis that looks to examine how each endogenous variable correlates separately to the latent variable. Where y1,y2,y3 represent observed variables of Chemical Type, Physical Type, and Number of micro plastics and n1 represents the unobservable, latent variable of environmental conditions. This is modeled by pre-establishing parameters indicated by the triangle paths. Where the intercept = 1 the covariance = 0. Creating a specified parameter changes the model to indicate no variability between observable variables and isolates the single factor.

```{r, warning=FALSE, message=FALSE}

pp2 <- readPNG("pathlegend3.png")
plot.new() 
rasterImage(pp2,0,0,1,1)

```




 
```{r, warning=FALSE, message=FALSE}
#creating latent variables and predictors
m2<- 'CON =~ Number + ChemType+ PhysType
#intercepts (nu = tau) 
#Specifying parameters on observed variables
Number ~ 1
ChemType ~ 1 
PhysType ~ 1' 
Fitm2 <- sem(m2, data=semdata) 
summary(Fitm2, standardized=TRUE)
semPaths(Fitm2, "par", edge.label.cex = 1, edge.label.position= .5, fade = FALSE)
```

# Model fit 3 path analysis
### Path diagram for model 3 
The final model is a path analysis where exogenous variables x1 and x2 (zones and proximity) predict and explain endogenous variables y1 and y2 (Chemical Type and Physical Type). This model helps explain how the variables are related to each other and like the previous model, isolates the observable variables to compare to one another by establishing a covariance of 0 when the intercept is 1. For example, in the model below Chemical Type (Cht), Physical Type (Pht), and Inputs (Inp) can predict Number of plastics (Nmb). However Pht is only predicted by Proximity to input (Prx) and Cht.

```{r, warning=FALSE, message=FALSE}
      

pp3 <- readPNG("pathlegend2.png")
plot.new() 
rasterImage(pp3,0,0,1,1)
```



```{r, warning=FALSE, message=FALSE}
m3 <- "Number ~ 1 + ChemType + PhysType
Inputs ~ 1 + Proximity + Zones"
fit3 <- sem(m3, data=semdata)
summary(fit3)
semPaths(fit3, "par", edge.label.cex = 1, edge.label.position= .5, fade = FALSE)
```


